<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ø³Ø¬Ù„ ØªÙ†ÙÙŠØ° Ø§Ù„ØªØ¬Ø§Ø±Ø¨ Ø§Ù„Ø¹Ù„Ù…ÙŠØ©</title>
  <style>
    :root{
      --bg:#0b1220;
      --text:#e8eefc;
      --muted:#9fb0d0;
      --border:rgba(255,255,255,.12);
      --accent:#60a5fa;
      --danger:#ef4444;
      --success:#22c55e;
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Tahoma, Arial, "Noto Kufi Arabic", "Noto Sans Arabic", sans-serif;
      background: radial-gradient(1200px 800px at 20% 0%, rgba(96,165,250,.22), transparent 50%),
                  radial-gradient(1200px 800px at 90% 10%, rgba(34,197,94,.12), transparent 55%),
                  var(--bg);
      color:var(--text);
    }

    header{
      position:sticky; top:0; z-index:10;
      padding:14px 16px;
      background: rgba(11,18,32,.72);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border);
    }
    .head-wrap{
      max-width:1150px; margin:0 auto;
      display:flex; flex-wrap:wrap; gap:12px; align-items:center; justify-content:space-between;
    }
    .brand{display:flex; gap:12px; align-items:center}
    .logo{
      width:46px; height:46px; display:grid; place-items:center;
      border-radius:14px;
      background: linear-gradient(135deg, rgba(96,165,250,.25), rgba(34,197,94,.14));
      border:1px solid var(--border);
      box-shadow: var(--shadow);
      font-size:20px;
    }
    .titles h1{margin:0; font-size:17px; line-height:1.35}
    .titles .sub{margin:4px 0 0; color:var(--muted); font-size:12px; line-height:1.6}
    .actions{display:flex; flex-wrap:wrap; gap:8px; align-items:center; justify-content:flex-end}
    .btn{
      border:none;
      border-radius: 12px;
      padding:10px 12px;
      background: rgba(96,165,250,.18);
      color: var(--text);
      border:1px solid rgba(96,165,250,.35);
      cursor:pointer;
      transition: transform .12s ease, filter .12s ease, opacity .12s ease;
      font-weight:700;
    }
    .btn:hover{filter: brightness(1.05); transform: translateY(-1px)}
    .btn:disabled{opacity:.45; cursor:not-allowed; transform:none}
    .btn.ghost{background: transparent;border:1px solid var(--border);}
    .btn.danger{background: rgba(239,68,68,.14);border-color: rgba(239,68,68,.35);}

    main{max-width:1150px; margin:0 auto; padding:16px}
    .toolbar{
      display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between;
      margin-top:10px;
    }
    .crumbs{
      color:var(--muted);
      padding:10px 12px;
      border:1px solid var(--border);
      background: rgba(16,26,45,.45);
      border-radius: 999px;
      font-size:13px;
    }
    .tools{display:flex; flex-wrap:wrap; gap:8px; align-items:center}
    .input{
      width: 220px;
      max-width: 80vw;
      padding:10px 12px;
      border-radius: 12px;
      border:1px solid var(--border);
      background: rgba(16,26,45,.6);
      color: var(--text);
      outline: none;
    }
    select.input{width: 160px}
    .input::placeholder{color: rgba(159,176,208,.75)}

    .grid-cards{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:12px;
      margin-top:14px;
    }
    @media (max-width: 900px){ .grid-cards{grid-template-columns: repeat(2, minmax(0, 1fr))} }
    @media (max-width: 560px){ .grid-cards{grid-template-columns: 1fr} }

    .card{
      background: linear-gradient(180deg, rgba(16,26,45,.95), rgba(15,23,48,.85));
      border:1px solid var(--border);
      border-radius: var(--radius);
      padding:14px;
      box-shadow: var(--shadow);
      cursor:pointer;
      transition: transform .12s ease, border-color .12s ease;
      user-select:none;
    }
    .card:hover{transform: translateY(-2px); border-color: rgba(96,165,250,.35)}
    .card .title{font-size:16px; margin:0 0 6px}
    .card .meta{color:var(--muted); font-size:13px; line-height:1.6}

    .panel{
      margin-top:14px;
      border:1px solid var(--border);
      border-radius: var(--radius);
      background: rgba(16,26,45,.45);
      box-shadow: var(--shadow);
      padding:12px;
      cursor:default;
    }
    .badges{display:flex; flex-wrap:wrap; gap:8px; margin-top:8px}
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      font-size:12px;
      white-space:nowrap;
    }
    .badge.done{background: rgba(34,197,94,.12); border-color: rgba(34,197,94,.35);}
    .badge.notDone{background: rgba(239,68,68,.10); border-color: rgba(239,68,68,.35);}

    table{
      width:100%;
      border-collapse: separate;
      border-spacing: 0;
      overflow:hidden;
      border-radius: var(--radius);
      border:1px solid var(--border);
      background: rgba(16,26,45,.55);
      box-shadow: var(--shadow);
      margin-top:12px;
    }
    th, td{
      padding:10px 10px;
      border-bottom:1px solid rgba(255,255,255,.06);
      vertical-align: middle;
      font-size:13px;
    }
    th{
      background: rgba(15,23,48,.85);
      color: var(--muted);
      font-weight: 800;
      text-align: right;
      position:sticky; top:0;
    }
    tr:hover td{background: rgba(96,165,250,.06)}
    a.link{color: var(--accent); text-decoration:none; cursor:pointer; font-weight:800}
    .small{color:var(--muted); font-size:12px}

    footer{
      margin:14px 0 0;
      display:flex; justify-content:space-between; gap:10px;
      color: var(--muted);
      font-size:12px;
      flex-wrap:wrap;
    }

    dialog{
      border:none;
      border-radius: var(--radius);
      padding:0;
      width: min(920px, 96vw);
      background: transparent;
    }
    dialog::backdrop{background: rgba(0,0,0,.55)}
    .modal{
      background: linear-gradient(180deg, rgba(16,26,45,.98), rgba(15,23,48,.95));
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
    }
    .modal-head{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px;}
    .icon-btn{
      border:none; background: transparent; color: var(--text);
      font-size:18px; cursor:pointer;
      padding:6px 10px; border-radius: 10px;
      border:1px solid var(--border);
    }
    .form-grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:10px;
    }
    .field{display:flex; flex-direction:column; gap:6px}
    .field label{color: var(--muted); font-size:12px}
    .field.full{grid-column: 1 / -1}
    textarea{width:100%; resize: vertical}

    .chips{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .chip{
      display:flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius: 999px;
      border:1px solid var(--border);
      background: rgba(16,26,45,.55);
      font-size:13px;
    }
    .chip input{accent-color: var(--accent)}
    .chip.success{border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.08)}
    .chip.danger{border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.06)}

    .modal-actions{display:flex; gap:10px; margin-top: 12px; flex-wrap:wrap}
    .toast{
      position:fixed;
      bottom:14px;
      right:14px;
      background: rgba(16,26,45,.95);
      border:1px solid var(--border);
      box-shadow: var(--shadow);
      padding:10px 12px;
      border-radius: 14px;
      font-size:13px;
      color: var(--text);
      opacity:0;
      transform: translateY(6px);
      transition: opacity .18s ease, transform .18s ease;
      pointer-events:none;
      z-index:999;
    }
    .toast.show{opacity:1; transform: translateY(0)}
  </style>
</head>

<body>
<header>
  <div class="head-wrap">
    <div class="brand">
      <div class="logo">ğŸ”¬</div>
      <div class="titles">
        <h1>ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ… â€¢ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø© Ù„ØªØ¹Ù„ÙŠÙ… Ø¨Ù…Ù†Ø·Ù‚Ø© Ø¹Ø³ÙŠØ±</h1>
        <div class="sub">
          Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ© Ø§Ù„Ø³Ø§Ø¯Ø³Ø© ÙˆØ§Ù„Ø«Ù„Ø§Ø«ÙˆÙ† Ø¨Ø§Ù„Ø®Ù…ÙŠØ³ â€” Ù…Ø¯ÙŠØ±Ø© Ø§Ù„Ù…Ø¯Ø±Ø³Ø©: Ù†ÙˆØ±Ø© Ø§Ù„Ø±ÙØ§Ø¹ÙŠ â€” Ø§Ù„Ù…Ø¹Ù„Ù…Ø©: Ø¨Ø¯Ø±ÙŠØ© Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ
        </div>
      </div>
    </div>

    <div class="actions">
      <button class="btn ghost" id="btnHome">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
      <button class="btn" id="btnExportCsv" disabled>ØªØµØ¯ÙŠØ± CSV</button>
      <button class="btn danger" id="btnClearTerm" disabled>Ù…Ø³Ø­ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ±Ù…</button>
    </div>
  </div>
</header>

<main>
  <section class="toolbar">
    <div class="crumbs" id="crumbs">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>

    <div class="tools">
      <input class="input" id="search" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† ØªØ¬Ø±Ø¨Ø©..." disabled />
      <select class="input" id="filterStatus" disabled>
        <option value="all">ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
        <option value="done">Ù†ÙÙÙ‘Ø°</option>
        <option value="notDone">Ù„Ù… ÙŠÙÙ†ÙÙ‘Ø°</option>
      </select>
      <select class="input" id="filterPlace" disabled>
        <option value="all">ÙƒÙ„ Ø§Ù„Ø£Ù…Ø§ÙƒÙ†</option>
        <option value="lab">Ø§Ù„Ù…Ø®ØªØ¨Ø±</option>
        <option value="class">Ø§Ù„ÙØµÙ„</option>
        <option value="other">Ù…ÙƒØ§Ù† Ø¢Ø®Ø±</option>
      </select>
    </div>
  </section>

  <div id="view"></div>

  <footer>
    <div>ÙŠØ¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† Ø³ÙŠØ±ÙØ± â€¢ Ø§Ù„Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„Ù…ØªØµÙØ­</div>
    <div>Ø¢Ø®Ø± Ø­ÙØ¸: <span id="lastSaved">â€”</span></div>
  </footer>
</main>

<dialog id="dlg">
  <form method="dialog" class="modal" id="dlgForm">
    <div class="modal-head">
      <h3 id="dlgTitle" style="margin:0">ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ¬Ø±Ø¨Ø©</h3>
      <button class="icon-btn" value="cancel" aria-label="Ø¥ØºÙ„Ø§Ù‚">âœ•</button>
    </div>

    <div class="form-grid">
      <div class="field">
        <label>Ø§Ù„Ù…Ø§Ø¯Ø©</label>
        <input class="input" id="f_subject" type="text" readonly />
      </div>

      <div class="field">
        <label>Ø§Ù„ÙØµÙ„</label>
        <input class="input" id="f_class" type="text" readonly />
      </div>

      <div class="field full">
        <label>Ø§Ø³Ù… Ø§Ù„ØªØ¬Ø±Ø¨Ø©</label>
        <input class="input" id="f_title" type="text" readonly />
      </div>

      <div class="field">
        <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…Ø©</label>
        <input class="input" id="f_teacher" type="text" placeholder="Ø¨Ø¯Ø±ÙŠØ© Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ" />
      </div>

      <div class="field">
        <label>Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„ØªØ¬Ø±Ø¨Ø©</label>
        <input class="input" id="f_week" type="number" min="1" placeholder="Ù…Ø«Ø§Ù„: 3" />
      </div>

      <div class="field">
        <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ (Ø§Ø®ØªÙŠØ§Ø± ØªÙØ§Ø¹Ù„ÙŠ)</label>
        <input class="input" id="f_date" type="date" />
      </div>

      <div class="field full">
        <label>Ù…ÙƒØ§Ù† Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„ØªØ¬Ø±Ø¨Ø©</label>
        <div class="chips">
          <label class="chip"><input type="radio" name="place" value="lab" /> Ø§Ù„Ù…Ø®ØªØ¨Ø±</label>
          <label class="chip"><input type="radio" name="place" value="class" /> Ø§Ù„ÙØµÙ„</label>
          <label class="chip"><input type="radio" name="place" value="other" /> Ù…ÙƒØ§Ù† Ø¢Ø®Ø±</label>
        </div>
        <input class="input" id="f_placeOther" type="text" placeholder="Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙƒØ§Ù† Ø¢Ø®Ø±ØŒ Ø§ÙƒØªØ¨ Ø§Ù„ÙˆØµÙ..." style="display:none;margin-top:8px" />
      </div>

      <div class="field full">
        <label>Ø§Ù„Ø­Ø§Ù„Ø©</label>
        <div class="chips">
          <label class="chip success"><input type="radio" name="status" value="done" /> Ù†ÙÙÙ‘Ø°</label>
          <label class="chip danger"><input type="radio" name="status" value="notDone" /> Ù„Ù… ÙŠÙÙ†ÙÙ‘Ø°</label>
        </div>
      </div>

      <div class="field full" id="reasonsBox" style="display:none">
        <label>Ø³Ø¨Ø¨ Ø¹Ø¯Ù… Ø§Ù„ØªÙ†ÙÙŠØ°</label>
        <div class="chips" style="align-items:flex-start">
          <label class="chip"><input type="checkbox" value="materials" /> Ù„Ø¹Ø¯Ù… ØªÙˆÙØ± Ø§Ù„Ù…ÙˆØ§Ø¯</label>
          <label class="chip"><input type="checkbox" value="prep" /> Ø¹Ø¯Ù… ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù…Ø­Ø¶Ø± Ù„Ù„Ø£Ø¯ÙˆØ§Øª</label>
          <label class="chip"><input type="checkbox" value="teacher" /> Ø¹Ø¯Ù… Ù‚ÙŠØ§Ù… Ø§Ù„Ù…Ø¹Ù„Ù… Ø¨Ø§Ù„ØªØ¬Ø±Ø¨Ø©</label>
          <label class="chip"><input type="checkbox" value="other" /> Ø£Ø³Ø¨Ø§Ø¨ Ø£Ø®Ø±Ù‰</label>
        </div>
        <input class="input" id="f_reasonOther" type="text" placeholder="Ø£Ø³Ø¨Ø§Ø¨ Ø£Ø®Ø±Ù‰ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)..." style="margin-top:8px" />
      </div>

      <div class="field full">
        <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
        <textarea class="input" id="f_notes" rows="3" placeholder="Ø§ÙƒØªØ¨ Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª..."></textarea>
      </div>
    </div>

    <div class="modal-actions">
      <button class="btn" id="btnSave" value="default">Ø­ÙØ¸</button>
      <button class="btn ghost" value="cancel">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </form>
</dialog>

<div class="toast" id="toast">ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ…</div>

<script>
(() => {
  // ===== Ø¨ÙŠØ§Ù†Ø§Øª (Ø¹ÙŠÙ†Ø© ÙƒØ§Ù…Ù„Ø© + Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„) =====
  // Ù…Ù„Ø§Ø­Ø¸Ø©: Ù„Ùˆ ØªØ±ÙŠØ¯ÙŠÙ† Ø£Ø¶Ø¹ Ù†ÙØ³ Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„ØªØ±Ù… Ø§Ù„Ø£ÙˆÙ„/Ø§Ù„Ø«Ø§Ù†ÙŠ Ø­Ø±ÙÙŠÙ‹Ø§ Ù…Ù† Ù…Ù„ÙØ§ØªÙƒØŒ Ø£Ø±Ø³Ù„ Ù„ÙŠ Ø§Ù„ØµÙØ­Ø§Øª/Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙˆØ³Ø£Ø«Ø¨ØªÙ‡Ø§ Ù„Ùƒ.
  const DATA = {
    teacherNameDefault: "Ø¨Ø¯Ø±ÙŠØ© Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ",
    grades: [
      { grade: 1, classes: [{ className: "1Ø¨", terms: {
        t1: [
          {id:"1t1-1", subject:"Ø¹Ù„ÙˆÙ…", title:"Ù…Ø§ Ø§Ù„Ù…Ø®Ù„ÙˆÙ‚Ø§Øª Ø§Ù„Ø­ÙŠØ©ØŸ ÙˆÙ…Ø§ Ø§Ù„Ø£Ø´ÙŠØ§Ø¡ ØºÙŠØ± Ø§Ù„Ø­ÙŠØ©ØŸ"},
          {id:"1t1-2", subject:"Ø¹Ù„ÙˆÙ…", title:"Ù…Ø§ Ø£Ø¬Ø²Ø§Ø¡ Ø§Ù„Ù†Ø¨Ø§ØªØŸ"},
          {id:"1t1-3", subject:"Ø¹Ù„ÙˆÙ…", title:"ÙƒÙŠÙ ÙŠÙ†ØªÙ‚Ù„ Ø§Ù„Ù…Ø§Ø¡ ÙÙŠ Ø§Ù„Ù†Ø¨Ø§ØªØŸ"}
        ],
        t2: [
          {id:"1t2-1", subject:"Ø¹Ù„ÙˆÙ…", title:"Ù…Ø§ Ø§Ù„Ø°ÙŠ Ø£Ù„Ø§Ø­Ø¸Ù‡ Ø¹Ù„Ù‰ Ø§Ù„Ù‡ÙˆØ§Ø¡ØŸ"},
          {id:"1t2-2", subject:"Ø¹Ù„ÙˆÙ…", title:"ÙƒÙŠÙ Ø£Ù‚ÙŠØ³ Ø§Ù„Ø·Ù‚Ø³ (Ø§Ù„Ø­Ø±Ø§Ø±Ø©)ØŸ"}
        ]
      }}]},

      { grade: 2, classes: [{ className: "2Ø¨", terms: {
        t1: [
          {id:"2t1-1", subject:"Ø¹Ù„ÙˆÙ…", title:"ÙƒÙŠÙ ÙŠØªØ­Ø±Ùƒ Ø§Ù„Ø¶ÙØ¯Ø¹ØŸ"},
          {id:"2t1-2", subject:"Ø¹Ù„ÙˆÙ…", title:"Ù…Ø§ Ø£Ø¬Ø²Ø§Ø¡ Ø§Ù„Ø¨Ø°Ø±Ø©ØŸ"}
        ],
        t2: [
          {id:"2t2-1", subject:"Ø¹Ù„ÙˆÙ…", title:"Ù„Ù…Ø§Ø°Ø§ Ù„Ø§ Ù†Ø±Ù‰ Ø§Ù„Ø´Ù…Ø³ ÙÙŠ Ø§Ù„Ù„ÙŠÙ„ØŸ"},
          {id:"2t2-2", subject:"Ø¹Ù„ÙˆÙ…", title:"Ø­Ø±ÙƒØ© Ø§Ù„Ø´Ù…Ø³"}
        ]
      }}]},

      { grade: 3, classes: [{ className: "3Ø¨", terms: {
        t1: [
          {id:"3t1-1", subject:"Ø¹Ù„ÙˆÙ…", title:"Ù…Ø§ Ø£ÙˆØ¬Ù‡ Ø§Ù„Ø§Ø®ØªÙ„Ø§Ù Ø¨ÙŠÙ† Ø§Ù„Ù…Ø®Ù„ÙˆÙ‚Ø§Øª Ø§Ù„Ø­ÙŠØ© ÙˆØ§Ù„Ø£Ø´ÙŠØ§Ø¡ ØºÙŠØ± Ø§Ù„Ø­ÙŠØ©ØŸ"},
          {id:"3t1-2", subject:"Ø¹Ù„ÙˆÙ…", title:"Ø£Ù„Ø§Ø­Ø¸ Ø§Ù„Ø®Ù„Ø§ÙŠØ§"}
        ],
        t2: [
          {id:"3t2-1", subject:"Ø¹Ù„ÙˆÙ…", title:"ÙƒÙŠÙ Ø£Ø«Ø¨Øª Ø£Ù† Ø§Ù„Ù‡ÙˆØ§Ø¡ Ù…ÙˆØ¬ÙˆØ¯ Ø­ÙˆÙ„ÙŠØŸ"},
          {id:"3t2-2", subject:"Ø¹Ù„ÙˆÙ…", title:"Ø£Ø¹Ù…Ù„ ÙƒÙŠØ³ Ø§Ù„Ø±ÙŠØ§Ø­"}
        ]
      }}]},

      { grade: 4, classes: [{ className: "4Ø¨", terms: {
        t1: [
          {id:"4t1-1", subject:"Ø¹Ù„ÙˆÙ…", title:"Ù…Ù…Ø§ ØªØªÙƒÙˆÙ† Ø§Ù„Ù…Ø®Ù„ÙˆÙ‚Ø§Øª Ø§Ù„Ø­ÙŠØ©ØŸ"},
          {id:"4t1-2", subject:"Ø¹Ù„ÙˆÙ…", title:"Ø§Ù„Ø®Ù„Ø§ÙŠØ§ ÙˆØ§Ù„Ø£Ù†Ø³Ø¬Ø© ÙˆØ§Ù„Ø£Ø¹Ø¶Ø§Ø¡"}
        ],
        t2: [
          {id:"4t2-1", subject:"Ø¹Ù„ÙˆÙ…", title:"Ù…Ø§ Ø³Ø¨Ø¨ ØªØ¹Ø§Ù‚Ø¨ Ø§Ù„Ù„ÙŠÙ„ ÙˆØ§Ù„Ù†Ù‡Ø§Ø±ØŸ"},
          {id:"4t2-2", subject:"Ø¹Ù„ÙˆÙ…", title:"Ø§Ù„Ø´Ù…Ø³ ÙˆØ§Ù„ÙØµÙˆÙ„"}
        ]
      }}]},

      { grade: 5, classes: [{ className: "5Ø¨", terms: {
        t1: [
          {id:"5t1-1", subject:"Ø¹Ù„ÙˆÙ…", title:"ÙƒÙŠÙ ÙŠÙ…ÙƒÙ† ØªØµÙ†ÙŠÙ Ø§Ù„Ù…Ø®Ù„ÙˆÙ‚Ø§Øª Ø§Ù„Ø­ÙŠØ©ØŸ"},
          {id:"5t1-2", subject:"Ø¹Ù„ÙˆÙ…", title:"Ø¹ÙÙ† Ø§Ù„Ø®Ø¨Ø²"}
        ],
        t2: [
          {id:"5t2-1", subject:"Ø¹Ù„ÙˆÙ…", title:"Ø§Ù„Ø¶ØºØ· Ø§Ù„Ø¬ÙˆÙŠ ÙˆØ§Ù„Ø­Ø¬Ù…"},
          {id:"5t2-2", subject:"Ø¹Ù„ÙˆÙ…", title:"Ù…Ø²Ø¬ Ø§Ù„Ø£Ù„ÙˆØ§Ù†"}
        ]
      }}]},

      { grade: 6, classes: [{ className: "6Ø¨", terms: {
        t1: [
          {id:"6t1-1", subject:"Ø¹Ù„ÙˆÙ…", title:"ÙƒÙŠÙ ØªØ¨Ø¯Ùˆ Ø§Ù„Ø®Ù„Ø§ÙŠØ§ØŸ"},
          {id:"6t1-2", subject:"Ø¹Ù„ÙˆÙ…", title:"Ø§Ù„Ø§Ù†ØªØ´Ø§Ø± ÙˆØ§Ù„Ø®Ø§ØµÙŠØ© Ø§Ù„Ø£Ø³Ù…ÙˆØ²ÙŠØ©"}
        ],
        t2: [
          {id:"6t2-1", subject:"Ø¹Ù„ÙˆÙ…", title:"ÙƒÙŠÙ ØªØ¹Ø±Ù Ø§Ù„ÙƒÙˆØ§ÙƒØ¨ØŸ"},
          {id:"6t2-2", subject:"Ø¹Ù„ÙˆÙ…", title:"Ø¹Ù…Ù„ Ù†Ù…ÙˆØ°Ø¬ Ù„Ù„Ø®Ø³ÙˆÙ ÙˆØ§Ù„ÙƒØ³ÙˆÙ"}
        ]
      }}]}
    ]
  };

  // ===== DOM =====
  const $ = (s, root=document) => root.querySelector(s);
  const view = $("#view");
  const crumbs = $("#crumbs");
  const lastSaved = $("#lastSaved");

  const btnHome = $("#btnHome");
  const btnExportCsv = $("#btnExportCsv");
  const btnClearTerm = $("#btnClearTerm");

  const search = $("#search");
  const filterStatus = $("#filterStatus");
  const filterPlace = $("#filterPlace");

  const dlg = $("#dlg");
  const dlgTitle = $("#dlgTitle");
  const dlgForm = $("#dlgForm");
  const toast = $("#toast");

  const f_subject = $("#f_subject");
  const f_class = $("#f_class");
  const f_title = $("#f_title");
  const f_teacher = $("#f_teacher");
  const f_week = $("#f_week");
  const f_date = $("#f_date");
  const f_placeOther = $("#f_placeOther");
  const f_reasonOther = $("#f_reasonOther");
  const f_notes = $("#f_notes");
  const reasonsBox = $("#reasonsBox");

  // ===== State/Storage =====
  const STORAGE_KEY = "science_log_overrides_clean_v1";
  const TS_KEY = STORAGE_KEY + "__ts";

  const state = {
    route: { grade:null, className:null, term:null },
    ui: { q:"", status:"all", place:"all" },
    overrides: loadJson(STORAGE_KEY, {})
  };

  let activeItems = [];
  let activeId = null;

  // ===== init =====
  wire();
  goHome();
  updateLastSaved();

  function wire(){
    btnHome.addEventListener("click", goHome);

    search.addEventListener("input", ()=>{
      state.ui.q = search.value.trim();
      renderTerm();
    });
    filterStatus.addEventListener("change", ()=>{
      state.ui.status = filterStatus.value;
      renderTerm();
    });
    filterPlace.addEventListener("change", ()=>{
      state.ui.place = filterPlace.value;
      renderTerm();
    });

    btnExportCsv.addEventListener("click", exportCSV);

    btnClearTerm.addEventListener("click", ()=>{
      const key = termKey();
      if(!key) return;
      if(!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ù‡Ø°Ø§ Ø§Ù„ØªØ±Ù…ØŸ")) return;
      delete state.overrides[key];
      saveJson(STORAGE_KEY, state.overrides);
      toastMsg("ØªÙ… Ù…Ø³Ø­ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ±Ù… âœ…");
      renderTerm();
    });

    dlgForm.addEventListener("submit", (e)=>{
      e.preventDefault();
      saveModal();
      dlg.close();
    });

    document.addEventListener("change", (e)=>{
      if(e.target && e.target.name === "status") toggleReasons();
      if(e.target && e.target.name === "place") togglePlaceOther();
    });
  }

  // ===== Navigation =====
  function goHome(){
    state.route = { grade:null, className:null, term:null };
    disableTools(true);
    crumbs.textContent = "Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©";
    renderGrades();
  }
  function goGrade(grade){
    state.route = { grade, className:null, term:null };
    disableTools(true);
    crumbs.textContent = `Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© / Ø§Ù„ØµÙ ${grade}`;
    const g = DATA.grades.find(x=>x.grade===grade);
    renderClasses(g);
  }
  function goClass(grade, className){
    state.route = { grade, className, term:null };
    disableTools(true);
    crumbs.textContent = `Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© / Ø§Ù„ØµÙ ${grade} / ${className}`;
    renderTerms(grade, className);
  }
  function goTerm(grade, className, term){
    state.route = { grade, className, term };

    state.ui = { q:"", status:"all", place:"all" };
    search.value = "";
    filterStatus.value = "all";
    filterPlace.value = "all";

    disableTools(false);
    crumbs.textContent = `Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© / Ø§Ù„ØµÙ ${grade} / ${className} / ${term==="t1" ? "Ø§Ù„ØªØ±Ù… Ø§Ù„Ø£ÙˆÙ„" : "Ø§Ù„ØªØ±Ù… Ø§Ù„Ø«Ø§Ù†ÙŠ"}`;
    renderTerm();
  }

  // ===== Render =====
  const cardHandlers = new Map();

  function renderGrades(){
    view.innerHTML = `
      <div class="grid-cards">
        ${[1,2,3,4,5,6].map(g => cardHtml(`Ø§Ù„ØµÙ ${g}`, `Ø¹Ø±Ø¶ Ø§Ù„ÙØµÙˆÙ„ ÙˆØ§Ù„ØªØ¬Ø§Ø±Ø¨ Ù„Ù„ØµÙ ${g}`, ()=>goGrade(g))).join("")}
      </div>
    `;
    bindCards();
  }

  function renderClasses(gradeObj){
    const classes = gradeObj?.classes || [];
    view.innerHTML = `
      <div class="grid-cards">
        ${
          classes.length
            ? classes.map(c=>{
                const total = (c.terms?.t1?.length||0) + (c.terms?.t2?.length||0);
                return cardHtml(`Ø§Ù„ÙØµÙ„ ${c.className}`, `Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ¬Ø§Ø±Ø¨: ${total}`, ()=>goClass(gradeObj.grade, c.className));
              }).join("")
            : emptyHtml("Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØµÙˆÙ„.")
        }
      </div>
    `;
    bindCards();
  }

  function renderTerms(grade, className){
    const cls = getClass(grade, className);
    const t1 = cls?.terms?.t1?.length || 0;
    const t2 = cls?.terms?.t2?.length || 0;

    view.innerHTML = `
      <div class="grid-cards">
        ${cardHtml("Ø§Ù„ØªØ±Ù… Ø§Ù„Ø£ÙˆÙ„", `Ø¹Ø¯Ø¯ Ø§Ù„ØªØ¬Ø§Ø±Ø¨: ${t1}`, ()=>goTerm(grade, className, "t1"))}
        ${cardHtml("Ø§Ù„ØªØ±Ù… Ø§Ù„Ø«Ø§Ù†ÙŠ", `Ø¹Ø¯Ø¯ Ø§Ù„ØªØ¬Ø§Ø±Ø¨: ${t2}`, ()=>goTerm(grade, className, "t2"))}
      </div>
    `;
    bindCards();
  }

  function renderTerm(){
    const cls = getClass(state.route.grade, state.route.className);
    const base = (cls?.terms?.[state.route.term] || []).map(x => normalize(x, cls.className));

    const key = termKey();
    const overrides = (key && state.overrides[key]) ? state.overrides[key] : {};
    const merged = base.map(it => ({...it, ...(overrides[it.id]||{})}));
    activeItems = merged;

    const filtered = merged.filter(it=>{
      const q = state.ui.q;
      const qOk = !q || it.title.includes(q) || (it.teacher||"").includes(q);
      const sOk = state.ui.status==="all" ? true : it.status===state.ui.status;
      const pOk = state.ui.place==="all" ? true : it.place===state.ui.place;
      return qOk && sOk && pOk;
    });

    const stats = getStats(merged);

    view.innerHTML = `
      <div class="panel">
        <div style="font-weight:900">Ù…Ù„Ø®Øµ Ø³Ø±ÙŠØ¹</div>
        <div class="badges">
          <span class="badge done">âœ”ï¸ Ù†ÙÙÙ‘Ø°: ${stats.done}</span>
          <span class="badge notDone">â— Ù„Ù… ÙŠÙÙ†ÙÙ‘Ø°: ${stats.notDone}</span>
          <span class="badge">ğŸ“Œ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${stats.total}</span>
        </div>
        <div class="small" style="margin-top:8px">* ÙŠØªÙ… Ø§Ù„Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ØªØµÙØ­.</div>
      </div>

      ${
        filtered.length
          ? `<table>
              <thead>
                <tr>
                  <th style="width:44px">Ù…</th>
                  <th>Ø§Ø³Ù… Ø§Ù„ØªØ¬Ø±Ø¨Ø©</th>
                  <th style="width:140px">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                  <th style="width:120px">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</th>
                  <th style="width:150px">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                  <th style="width:140px">Ø§Ù„Ù…ÙƒØ§Ù†</th>
                  <th style="width:160px">Ø§Ù„Ù…Ø¹Ù„Ù…Ø©</th>
                  <th style="width:110px">Ø¥Ø¬Ø±Ø§Ø¡</th>
                </tr>
              </thead>
              <tbody>
                ${filtered.map((it, i)=>rowHtml(it, i+1)).join("")}
              </tbody>
            </table>`
          : emptyHtml("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø©.")
      }
    `;

    view.querySelectorAll("[data-edit]").forEach(el=>{
      el.addEventListener("click", ()=> openModal(el.getAttribute("data-edit")));
    });

    updateLastSaved();
  }

  function rowHtml(it, idx){
    const badge = it.status==="done"
      ? `<span class="badge done">âœ”ï¸ Ù†ÙÙÙ‘Ø°</span>`
      : it.status==="notDone"
        ? `<span class="badge notDone">â— Ù„Ù… ÙŠÙÙ†ÙÙ‘Ø°</span>`
        : `<span class="badge">â€” ØºÙŠØ± Ù…Ø­Ø¯Ø¯</span>`;

    const placeTxt = it.place==="lab" ? "Ø§Ù„Ù…Ø®ØªØ¨Ø±"
      : it.place==="class" ? "Ø§Ù„ÙØµÙ„"
      : it.place==="other" ? (it.placeOther || "Ù…ÙƒØ§Ù† Ø¢Ø®Ø±")
      : "â€”";

    return `
      <tr>
        <td>${idx}</td>
        <td>
          <div style="font-weight:900">${esc(it.title)}</div>
          <div class="small">Ø§Ù„Ù…Ø§Ø¯Ø©: ${esc(it.subject)} â€¢ Ø§Ù„ÙØµÙ„: ${esc(it.className)}</div>
        </td>
        <td>${badge}</td>
        <td>${it.week ?? "â€”"}</td>
        <td>${it.date || "â€”"}</td>
        <td>${esc(placeTxt)}</td>
        <td>${esc(it.teacher || DATA.teacherNameDefault || "â€”")}</td>
        <td><a class="link" data-edit="${esc(it.id)}">ØªØ¹Ø¯ÙŠÙ„</a></td>
      </tr>
    `;
  }

  function cardHtml(title, meta, fn){
    const id = "c_" + Math.random().toString(16).slice(2);
    cardHandlers.set(id, fn);
    return `
      <div class="card" data-card="${id}">
        <h3 class="title">${esc(title)}</h3>
        <div class="meta">${esc(meta)}</div>
      </div>
    `;
  }

  function bindCards(){
    view.querySelectorAll("[data-card]").forEach(el=>{
      const id = el.getAttribute("data-card");
      el.addEventListener("click", ()=> cardHandlers.get(id)?.());
    });
    cardHandlers.clear();
  }

  // ===== Modal =====
  function openModal(id){
    const it = activeItems.find(x=>x.id===id);
    if(!it) return;

    activeId = id;
    dlgTitle.textContent = "ØªÙØ§ØµÙŠÙ„: " + it.title;

    f_subject.value = it.subject || "";
    f_class.value = it.className || "";
    f_title.value = it.title || "";

    f_teacher.value = it.teacher || DATA.teacherNameDefault || "";
    f_week.value = (it.week ?? "");
    f_date.value = it.date || ""; // âœ… ØªÙØ§Ø¹Ù„ÙŠ Ù…Ù† Ø§Ù„ØªÙ‚ÙˆÙŠÙ…

    setRadio("place", it.place || "");
    f_placeOther.value = it.placeOther || "";
    togglePlaceOther();

    setRadio("status", it.status || "");
    toggleReasons();

    setReasons(it.reasons || []);
    f_reasonOther.value = it.reasonOther || "";
    f_notes.value = it.notes || "";

    dlg.showModal();
  }

  function saveModal(){
    const it = activeItems.find(x=>x.id===activeId);
    if(!it) return;

    const place = getRadio("place");
    const status = getRadio("status");

    const updated = {
      teacher: str(f_teacher.value) || DATA.teacherNameDefault || "",
      week: f_week.value ? Number(f_week.value) : null,
      date: str(f_date.value), // âœ… ÙŠÙØ­ÙØ¸ Ø­Ø³Ø¨ Ø§Ø®ØªÙŠØ§Ø±Ùƒ
      place: place || null,
      placeOther: place==="other" ? str(f_placeOther.value) : "",
      status: status || null,
      reasons: status==="notDone" ? getReasons() : [],
      reasonOther: status==="notDone" ? str(f_reasonOther.value) : "",
      notes: str(f_notes.value)
    };

    const key = termKey();
    if(!key) return;

    state.overrides[key] = state.overrides[key] || {};
    state.overrides[key][it.id] = { ...(state.overrides[key][it.id]||{}), ...updated };

    saveJson(STORAGE_KEY, state.overrides);
    toastMsg("ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ…");
    renderTerm();
  }

  function toggleReasons(){
    const status = getRadio("status");
    reasonsBox.style.display = (status==="notDone") ? "block" : "none";
  }
  function togglePlaceOther(){
    const place = getRadio("place");
    f_placeOther.style.display = (place==="other") ? "block" : "none";
  }

  function getReasons(){
    const arr = [];
    reasonsBox.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
      if(cb.checked) arr.push(cb.value);
    });
    return arr;
  }
  function setReasons(list){
    const set = new Set(list||[]);
    reasonsBox.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
      cb.checked = set.has(cb.value);
    });
  }

  // ===== Export CSV =====
  function exportCSV(){
    if(!state.route.term) return;

    const termLabel = state.route.term==="t1" ? "Ø§Ù„Ø£ÙˆÙ„" : "Ø§Ù„Ø«Ø§Ù†ÙŠ";
    const rows = activeItems.map(it=>{
      const placeTxt = it.place==="lab" ? "Ø§Ù„Ù…Ø®ØªØ¨Ø±" : it.place==="class" ? "Ø§Ù„ÙØµÙ„" : it.place==="other" ? "Ù…ÙƒØ§Ù† Ø¢Ø®Ø±" : "";
      return [
        state.route.grade,
        it.className,
        termLabel,
        it.subject,
        it.title,
        it.status || "",
        it.week ?? "",
        it.date || "",
        placeTxt,
        it.placeOther || "",
        it.teacher || "",
        (it.reasons||[]).join("|"),
        it.reasonOther || "",
        it.notes || ""
      ];
    });

    const header = ["Ø§Ù„ØµÙ","Ø§Ù„ÙØµÙ„","Ø§Ù„ØªØ±Ù…","Ø§Ù„Ù…Ø§Ø¯Ø©","Ø§Ø³Ù… Ø§Ù„ØªØ¬Ø±Ø¨Ø©","Ø§Ù„Ø­Ø§Ù„Ø©","Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹","Ø§Ù„ØªØ§Ø±ÙŠØ®","Ø§Ù„Ù…ÙƒØ§Ù†","Ù…ÙƒØ§Ù† Ø¢Ø®Ø±","Ø§Ù„Ù…Ø¹Ù„Ù…Ø©","Ø£Ø³Ø¨Ø§Ø¨ Ø¹Ø¯Ù… Ø§Ù„ØªÙ†ÙÙŠØ°","Ø£Ø³Ø¨Ø§Ø¨ Ø£Ø®Ø±Ù‰","Ù…Ù„Ø§Ø­Ø¸Ø§Øª"];
    const csv = [header, ...rows].map(r=>r.map(csvCell).join(",")).join("\n");
    download(`Ø³Ø¬Ù„-Ø§Ù„ØªØ¬Ø§Ø±Ø¨-ØµÙ${state.route.grade}-${state.route.className}-ØªØ±Ù…${termLabel}.csv`, csv, "text/csv;charset=utf-8;");
  }

  // ===== Helpers =====
  function getClass(grade, className){
    const g = DATA.grades.find(x=>x.grade===grade);
    if(!g) return null;
    return g.classes.find(c=>c.className===className) || null;
  }

  function normalize(item, fallbackClass){
    return {
      id: String(item.id),
      subject: item.subject || "Ø¹Ù„ÙˆÙ…",
      title: item.title || "",
      className: item.classOverride || fallbackClass || "",
      teacher: item.teacher || "",
      week: item.week ?? null,
      date: item.date || "",
      place: item.place ?? null,
      placeOther: item.placeOther || "",
      status: item.status ?? null,
      reasons: item.reasons || [],
      reasonOther: item.reasonOther || "",
      notes: item.notes || ""
    };
  }

  function getStats(items){
    let done=0, notDone=0;
    items.forEach(it=>{
      if(it.status==="done") done++;
      if(it.status==="notDone") notDone++;
    });
    return { total: items.length, done, notDone };
  }

  function termKey(){
    const r = state.route;
    if(!r.grade || !r.className || !r.term) return null;
    return `g${r.grade}_${r.className}_${r.term}`;
  }

  function disableTools(disabled){
    search.disabled = disabled;
    filterStatus.disabled = disabled;
    filterPlace.disabled = disabled;
    btnExportCsv.disabled = disabled;
    btnClearTerm.disabled = disabled;
  }

  function emptyHtml(msg){
    return `
      <div class="panel">
        <div style="font-weight:900">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</div>
        <div class="small" style="margin-top:6px">${esc(msg)}</div>
      </div>
    `;
  }

  function setRadio(name, value){
    document.querySelectorAll(`input[type="radio"][name="${name}"]`).forEach(r=>{
      r.checked = (r.value === value);
    });
  }
  function getRadio(name){
    const r = document.querySelector(`input[type="radio"][name="${name}"]:checked`);
    return r ? r.value : "";
  }

  function saveJson(key, val){
    localStorage.setItem(key, JSON.stringify(val));
    localStorage.setItem(TS_KEY, new Date().toISOString());
    updateLastSaved();
  }
  function loadJson(key, fallback){
    try{
      const raw = localStorage.getItem(key);
      return raw ? JSON.parse(raw) : fallback;
    }catch{
      return fallback;
    }
  }

  function updateLastSaved(){
    const ts = localStorage.getItem(TS_KEY);
    if(!ts){ lastSaved.textContent = "â€”"; return; }
    lastSaved.textContent = new Date(ts).toLocaleString("ar-SA");
  }

  function toastMsg(msg){
    toast.textContent = msg;
    toast.classList.add("show");
    setTimeout(()=>toast.classList.remove("show"), 1200);
  }

  function csvCell(v){
    const s = String(v ?? "");
    if (/[,"\n]/.test(s)) return '"' + s.replaceAll('"','""') + '"';
    return s;
  }
  function download(filename, content, mime){
    const blob = new Blob([content], {type:mime});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function esc(str){
    return String(str ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }
  function str(s){ return String(s ?? "").trim(); }

})();
</script>
</body>
</html>
